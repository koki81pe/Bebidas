<script>
/*
***********************************************
Bebidas a Pedido - scripts.html - V1.09
23/12/2024 - 19:00
***********************************************
*/

/* ***********************************************
   01. Variables Globales - scripts.html - V1.09-SV01
   *********************************************** */

let licoresData = [];
let productosSeleccionados = [];
let pedidosData = [];
let vistaActual = 'productos'; // 'productos' o 'pedidos'
let tabActual = 'todos'; // 'todos', 'pendientes' o 'pagados'

// URL base de GitHub para fotos de productos
const FOTOS_BASE_URL = 'https://raw.githubusercontent.com/koki81pe/Bebidas/refs/heads/main/Fotos/';

/* ***********************************************
   02. Inicializaci√≥n - scripts.html - V1.06-SV01
   *********************************************** */

document.addEventListener('DOMContentLoaded', function() {
  console.log('Inicializando Bebidas a Pedido V1.06...');
  cargarLicores();
  configurarEventos();
});

/* ***********************************************
   03. Configurar Eventos - scripts.html - V1.02-SV01
   *********************************************** */

function configurarEventos() {
  // Bot√≥n Admin
  const btnAdmin = document.getElementById('btnAdmin');
  if (btnAdmin) {
    btnAdmin.addEventListener('click', abrirModalLogin);
  }
  
  // Bot√≥n Hacer Pedido
  const btnHacerPedido = document.getElementById('btnHacerPedido');
  if (btnHacerPedido) {
    btnHacerPedido.addEventListener('click', abrirModalCliente);
  }
  
  // Enter en inputs
  const inputUsuario = document.getElementById('inputUsuario');
  if (inputUsuario) {
    inputUsuario.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verificarAcceso();
      }
    });
  }
  
  const inputCliente = document.getElementById('inputCliente');
  if (inputCliente) {
    inputCliente.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const inputTelefono = document.getElementById('inputTelefono');
        if (inputTelefono) inputTelefono.focus();
      }
    });
  }
  
  const inputTelefono = document.getElementById('inputTelefono');
  if (inputTelefono) {
    inputTelefono.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        confirmarPedido();
      }
    });
  }
  
  console.log('Eventos configurados');
}

/* ***********************************************
   04. Cargar Licores - scripts.html - V1.02-SV01
   *********************************************** */

function cargarLicores() {
  const loader = document.getElementById('loader');
  const listaProductos = document.getElementById('listaProductos');
  
  console.log('Cargando licores desde el servidor...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('Respuesta recibida:', resultado);
      
      if (resultado.success) {
        licoresData = resultado.data;
        console.log(`${licoresData.length} licores cargados`);
        renderizarLicores();
        
        // Ocultar loader, mostrar productos
        if (loader) loader.style.display = 'none';
        if (listaProductos) listaProductos.style.display = 'grid';
        
        mostrarInfo('Listo', `${licoresData.length} productos disponibles`);
      } else {
        throw new Error(resultado.message || 'Error al cargar licores');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar licores:', error);
      if (loader) loader.style.display = 'none';
      manejarError(error, 'al cargar productos');
    })
    .getLicores();
}

/* ***********************************************
   05. Renderizar Licores - scripts.html - V1.02-SV01
   *********************************************** */

function renderizarLicores() {
  const listaProductos = document.getElementById('listaProductos');
  if (!listaProductos) {
    console.error('Contenedor de productos no encontrado');
    return;
  }
  
  listaProductos.innerHTML = '';
  
  if (licoresData.length === 0) {
    listaProductos.innerHTML = '<p class="text-center">No hay productos disponibles</p>';
    return;
  }
  
  licoresData.forEach((licor, index) => {
    const card = crearCardProducto(licor, index);
    listaProductos.appendChild(card);
  });
  
  console.log('Licores renderizados');
}

/* ***********************************************
   06. Crear Card de Producto - scripts.html - V1.09-SV01
   *********************************************** */

function crearCardProducto(licor, index) {
  const card = document.createElement('div');
  card.className = 'producto-card';
  card.dataset.index = index;
  
  // Construir URL de foto
  const urlFoto = FOTOS_BASE_URL + licor.code + '.jpg';
  
  card.innerHTML = `
    <div class="producto-selector">‚óã</div>
    <a href="${urlFoto}" target="_blank" class="btn-ver-foto" onclick="event.stopPropagation()">Ver Foto ‚Üó</a>
    <div class="producto-nombre">${licor.producto}</div>
    <div class="producto-detalles">
      <span class="producto-detalle">${licor.empaque}</span>
      <span class="producto-detalle">${licor.size}</span>
    </div>
    <div class="producto-stock">Stock: ${licor.saldoInicial} unidades</div>
    <div class="producto-precio">S/ ${parseFloat(licor.precio).toFixed(2)}</div>
    <div class="producto-cantidad-control" style="display: none;">
      <label>Cantidad:</label>
      <div class="cantidad-input-group">
        <button class="btn-cantidad" onclick="cambiarCantidad(${index}, -1)">‚àí</button>
        <input type="number" class="cantidad-input" id="cantidad_${index}" value="1" min="1" max="${licor.saldoInicial}" readonly>
        <button class="btn-cantidad" onclick="cambiarCantidad(${index}, 1)">+</button>
      </div>
    </div>
  `;
  
  card.addEventListener('click', function(e) {
    // Evitar toggle si se hace clic en los botones de cantidad o link de foto
    if (e.target.classList.contains('btn-cantidad') || 
        e.target.classList.contains('cantidad-input') ||
        e.target.classList.contains('btn-ver-foto')) {
      return;
    }
    toggleProducto(index);
  });
  
  return card;
}

/* ***********************************************
   07. Toggle Producto - scripts.html - V1.02-SV01
   *********************************************** */

function toggleProducto(index) {
  const licor = licoresData[index];
  const card = document.querySelector(`.producto-card[data-index="${index}"]`);
  
  if (!card) return;
  
  const selector = card.querySelector('.producto-selector');
  const cantidadControl = card.querySelector('.producto-cantidad-control');
  const cantidadInput = document.getElementById(`cantidad_${index}`);
  
  // Verificar si ya est√° seleccionado
  const indexSeleccionado = productosSeleccionados.findIndex(p => p.code === licor.code);
  
  if (indexSeleccionado !== -1) {
    // Deseleccionar
    productosSeleccionados.splice(indexSeleccionado, 1);
    card.classList.remove('selected');
    if (selector) selector.textContent = '‚óã';
    if (cantidadControl) cantidadControl.style.display = 'none';
    if (cantidadInput) cantidadInput.value = 1;
  } else {
    // Seleccionar
    const cantidad = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
    productosSeleccionados.push({
      code: licor.code,
      producto: licor.producto,
      empaque: licor.empaque,
      size: licor.size,
      precio: parseFloat(licor.precio),
      cantidad: cantidad,
      index: index
    });
    card.classList.add('selected');
    if (selector) selector.textContent = '‚óè';
    if (cantidadControl) cantidadControl.style.display = 'flex';
  }
  
  actualizarTotal();
}

/* ***********************************************
   08. Cambiar Cantidad - scripts.html - V1.02-SV01
   *********************************************** */

function cambiarCantidad(index, cambio) {
  const licor = licoresData[index];
  const cantidadInput = document.getElementById(`cantidad_${index}`);
  
  if (!cantidadInput) return;
  
  let nuevaCantidad = parseInt(cantidadInput.value) + cambio;
  
  // Validar l√≠mites
  const max = licor.saldoInicial;
  if (nuevaCantidad < 1) nuevaCantidad = 1;
  if (nuevaCantidad > max) nuevaCantidad = max;
  
  cantidadInput.value = nuevaCantidad;
  
  // Actualizar en el array de seleccionados
  const productoSeleccionado = productosSeleccionados.find(p => p.code === licor.code);
  if (productoSeleccionado) {
    productoSeleccionado.cantidad = nuevaCantidad;
    actualizarTotal();
  }
}

/* ***********************************************
   09. Actualizar Total - scripts.html - V1.02-SV01
   *********************************************** */

function actualizarTotal() {
  const totalAmount = document.getElementById('totalAmount');
  const btnHacerPedido = document.getElementById('btnHacerPedido');
  const footerPedido = document.getElementById('footerPedido');
  
  const total = productosSeleccionados.reduce((sum, prod) => sum + (prod.precio * prod.cantidad), 0);
  
  if (totalAmount) {
    totalAmount.textContent = `S/ ${total.toFixed(2)}`;
  }
  
  if (btnHacerPedido) {
    if (productosSeleccionados.length > 0) {
      btnHacerPedido.disabled = false;
      if (footerPedido) footerPedido.style.display = 'flex';
    } else {
      btnHacerPedido.disabled = true;
      if (footerPedido) footerPedido.style.display = 'none';
    }
  }
  
  console.log(`Total actualizado: S/ ${total.toFixed(2)} - Productos: ${productosSeleccionados.length}`);
}

/* ***********************************************
   10. Modal Login Admin - scripts.html - V1.02-SV01
   *********************************************** */

function abrirModalLogin() {
  const modal = document.getElementById('modalLogin');
  const input = document.getElementById('inputUsuario');
  
  if (modal) {
    modal.style.display = 'flex';
    if (input) {
      input.value = '';
      setTimeout(() => input.focus(), 100);
    }
  }
}

function cerrarModalLogin() {
  const modal = document.getElementById('modalLogin');
  if (modal) {
    modal.style.display = 'none';
  }
}

function verificarAcceso() {
  const input = document.getElementById('inputUsuario');
  if (!input) return;
  
  const usuario = input.value.trim();
  
  if (!usuario) {
    mostrarAdvertencia('Campo vac√≠o', 'Ingresa tu c√≥digo de acceso');
    return;
  }
  
  LoaderGlobal.mostrar('Verificando...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      LoaderGlobal.ocultar();
      
      if (resultado.success) {
        cerrarModalLogin();
        mostrarExito('Acceso concedido', 'Bienvenido');
        mostrarVistaPedidos();
      } else {
        mostrarError('Acceso denegado', 'C√≥digo no v√°lido');
        input.value = '';
        input.focus();
      }
    })
    .withFailureHandler(function(error) {
      LoaderGlobal.ocultar();
      manejarError(error, 'al verificar acceso');
    })
    .verificarAcceso(usuario);
}

/* ***********************************************
   11. Modal Nombre y Tel√©fono Cliente - scripts.html - V1.02-SV01
   *********************************************** */

function abrirModalCliente() {
  if (productosSeleccionados.length === 0) {
    mostrarAdvertencia('Sin productos', 'Selecciona al menos un producto');
    return;
  }
  
  const modal = document.getElementById('modalCliente');
  const inputCliente = document.getElementById('inputCliente');
  const inputTelefono = document.getElementById('inputTelefono');
  
  if (modal) {
    modal.style.display = 'flex';
    if (inputCliente) {
      inputCliente.value = '';
      setTimeout(() => inputCliente.focus(), 100);
    }
    if (inputTelefono) {
      inputTelefono.value = '';
    }
  }
}

function cerrarModalCliente() {
  const modal = document.getElementById('modalCliente');
  if (modal) {
    modal.style.display = 'none';
  }
}

function confirmarPedido() {
  const inputCliente = document.getElementById('inputCliente');
  const inputTelefono = document.getElementById('inputTelefono');
  
  if (!inputCliente || !inputTelefono) return;
  
  const cliente = inputCliente.value.trim();
  const telefono = inputTelefono.value.trim();
  
  if (!cliente) {
    mostrarAdvertencia('Campo vac√≠o', 'Ingresa tu nombre');
    inputCliente.focus();
    return;
  }
  
  if (!telefono) {
    mostrarAdvertencia('Campo vac√≠o', 'Ingresa tu tel√©fono');
    inputTelefono.focus();
    return;
  }
  
  if (productosSeleccionados.length === 0) {
    mostrarAdvertencia('Sin productos', 'Selecciona al menos un producto');
    cerrarModalCliente();
    return;
  }
  
  // Cerrar modal y mostrar loader
  cerrarModalCliente();
  LoaderGlobal.mostrar('Generando pedido...');
  
  console.log('Guardando pedido:', { cliente, telefono, productos: productosSeleccionados });
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      LoaderGlobal.ocultar();
      
      if (resultado.success) {
        console.log('Pedido guardado exitosamente:', resultado.pedidoId);
        mostrarModalPedidoGenerado(cliente, resultado.pedidoId);
        limpiarSeleccion();
      } else {
        throw new Error(resultado.message || 'Error al guardar pedido');
      }
    })
    .withFailureHandler(function(error) {
      LoaderGlobal.ocultar();
      manejarError(error, 'al guardar el pedido');
    })
    .guardarPedido(cliente, telefono, productosSeleccionados);
}

/* ***********************************************
   12. Modal Pedido Generado - scripts.html - V1.02-SV01
   *********************************************** */

function mostrarModalPedidoGenerado(cliente, pedidoId) {
  const modal = document.getElementById('modalPedidoGenerado');
  const pedidoIdElement = document.getElementById('pedidoIdGenerado');
  const pedidoClienteElement = document.getElementById('pedidoClienteNombre');
  const textoWhatsapp = document.getElementById('textoWhatsapp');
  
  if (!modal) return;
  
  // Establecer informaci√≥n
  if (pedidoIdElement) pedidoIdElement.textContent = pedidoId;
  if (pedidoClienteElement) pedidoClienteElement.textContent = cliente;
  
  // Generar texto WhatsApp
  const texto = generarTextoWhatsApp();
  if (textoWhatsapp) textoWhatsapp.value = texto;
  
  // Mostrar modal
  modal.style.display = 'flex';
  
  mostrarExito('¬°Pedido registrado!', `Pedido ${pedidoId} guardado exitosamente`);
}

function cerrarModalPedidoGenerado() {
  const modal = document.getElementById('modalPedidoGenerado');
  if (modal) {
    modal.style.display = 'none';
  }
}

/* ***********************************************
   13. Generar Texto WhatsApp - scripts.html - V1.02-SV01
   *********************************************** */

function generarTextoWhatsApp() {
  let texto = '';
  let total = 0;
  
  productosSeleccionados.forEach(prod => {
    const subtotal = prod.precio * prod.cantidad;
    texto += `- ${prod.producto} ${prod.empaque} ${prod.size} x${prod.cantidad} S/${subtotal.toFixed(2)}\n`;
    total += subtotal;
  });
  
  texto += `*Total: S/${total.toFixed(2)}*`;
  
  return texto;
}

/* ***********************************************
   14. Copiar Texto - scripts.html - V1.02-SV01
   *********************************************** */

function copiarTexto() {
  const textoWhatsapp = document.getElementById('textoWhatsapp');
  
  if (!textoWhatsapp) {
    mostrarError('Error', 'No se encontr√≥ el texto a copiar');
    return;
  }
  
  textoWhatsapp.select();
  textoWhatsapp.setSelectionRange(0, 99999); // Para m√≥viles
  
  try {
    document.execCommand('copy');
    mostrarExito('¬°Copiado!', 'Texto copiado al portapapeles');
  } catch (error) {
    console.error('Error al copiar:', error);
    mostrarError('Error', 'No se pudo copiar el texto');
  }
}

/* ***********************************************
   15. Limpiar Selecci√≥n - scripts.html - V1.02-SV01
   *********************************************** */

function limpiarSeleccion() {
  // Limpiar array
  productosSeleccionados = [];
  
  // Remover clase selected de todas las cards y resetear selectores
  const cards = document.querySelectorAll('.producto-card');
  cards.forEach(card => {
    card.classList.remove('selected');
    const selector = card.querySelector('.producto-selector');
    const cantidadControl = card.querySelector('.producto-cantidad-control');
    if (selector) selector.textContent = '‚óã';
    if (cantidadControl) cantidadControl.style.display = 'none';
  });
  
  // Actualizar total
  actualizarTotal();
  
  console.log('Selecci√≥n limpiada');
}

/* ***********************************************
   16. Vista Pedidos - scripts.html - V1.06-SV01
   *********************************************** */

function mostrarVistaPedidos() {
  const vistaProductos = document.getElementById('vistaProductos');
  const vistaPedidos = document.getElementById('vistaPedidos');
  
  if (vistaProductos) vistaProductos.style.display = 'none';
  if (vistaPedidos) vistaPedidos.style.display = 'block';
  
  vistaActual = 'pedidos';
  tabActual = 'todos'; // Resetear a pesta√±a "Todos" al entrar
  cargarPedidos();
}

function volverHome() {
  const vistaProductos = document.getElementById('vistaProductos');
  const vistaPedidos = document.getElementById('vistaPedidos');
  
  if (vistaProductos) vistaProductos.style.display = 'block';
  if (vistaPedidos) vistaPedidos.style.display = 'none';
  
  vistaActual = 'productos';
  console.log('Volviendo a vista de productos');
}

/* ***********************************************
   17. Cargar Pedidos - scripts.html - V1.02-SV01
   *********************************************** */

function cargarPedidos() {
  const listaPedidos = document.getElementById('listaPedidos');
  
  if (!listaPedidos) {
    console.error('Contenedor de pedidos no encontrado');
    return;
  }
  
  // Mostrar loader
  listaPedidos.innerHTML = `
    <div class="loader-container">
      <div class="loader"></div>
      <p>Cargando pedidos...</p>
    </div>
  `;
  
  console.log('Cargando pedidos desde el servidor...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      console.log('Pedidos recibidos:', resultado);
      
      if (resultado.success) {
        pedidosData = resultado.data;
        console.log(`${pedidosData.length} pedidos cargados`);
        renderizarPedidos();
      } else {
        throw new Error(resultado.message || 'Error al cargar pedidos');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar pedidos:', error);
      listaPedidos.innerHTML = '<p class="text-center">Error al cargar pedidos</p>';
      manejarError(error, 'al cargar pedidos');
    })
    .getPedidos();
}

/* ***********************************************
   18. Renderizar Pedidos - scripts.html - V1.06-SV01
   *********************************************** */

function renderizarPedidos() {
  const listaPedidos = document.getElementById('listaPedidos');
  
  if (!listaPedidos) {
    console.error('Contenedor de pedidos no encontrado');
    return;
  }
  
  listaPedidos.innerHTML = '';
  
  if (pedidosData.length === 0) {
    listaPedidos.innerHTML = '<p class="text-center">No hay pedidos registrados</p>';
    return;
  }
  
  // Filtrar pedidos seg√∫n la pesta√±a activa
  let pedidosFiltrados = pedidosData;
  
  if (tabActual === 'pendientes') {
    pedidosFiltrados = pedidosData.filter(p => p.estado === 'Pendiente');
  } else if (tabActual === 'pagados') {
    pedidosFiltrados = pedidosData.filter(p => p.estado === 'Pagado');
  }
  
  if (pedidosFiltrados.length === 0) {
    const mensajes = {
      'todos': 'No hay pedidos registrados',
      'pendientes': 'No hay pedidos pendientes',
      'pagados': 'No hay pedidos pagados'
    };
    listaPedidos.innerHTML = `<p class="text-center">${mensajes[tabActual]}</p>`;
    return;
  }
  
  pedidosFiltrados.forEach(pedido => {
    const card = crearCardPedido(pedido);
    listaPedidos.appendChild(card);
  });
  
  console.log(`Pedidos renderizados (${tabActual}): ${pedidosFiltrados.length}`);
}

/* ***********************************************
   19. Crear Card de Pedido - scripts.html - V1.02-SV01
   *********************************************** */

function crearCardPedido(pedido) {
  const card = document.createElement('div');
  card.className = `pedido-item fade-in ${pedido.estado === 'Pagado' ? 'pedido-pagado' : ''}`;
  
  // Badge de estado
  const badgeClase = pedido.estado === 'Pagado' ? 'badge-pagado' : 'badge-pendiente';
  
  // Generar lista de productos
  let productosHTML = '';
  pedido.productos.forEach(prod => {
    productosHTML += `
      <div class="pedido-producto-item">
        <div class="pedido-producto-info">
          <div class="pedido-producto-nombre">${prod.producto} <span class="producto-cantidad-badge">x${prod.cantidad}</span></div>
          <div class="pedido-producto-detalles">${prod.empaque} ‚Ä¢ ${prod.size}</div>
        </div>
        <div class="pedido-producto-precio">S/ ${(parseFloat(prod.precio) * prod.cantidad).toFixed(2)}</div>
      </div>
    `;
  });
  
  // Bot√≥n marcar pagado (solo si est√° Pendiente)
  const botonPagado = pedido.estado === 'Pendiente' ? 
    `<button class="btn-marcar-pagado" onclick="marcarComoPagado('${pedido.pedidoId}')">‚úì Marcar Pagado</button>` : '';
  
  card.innerHTML = `
    <div class="pedido-header-info">
      <div class="pedido-cliente-info">
        <div class="pedido-cliente-nombre">${pedido.cliente}</div>
        <div class="pedido-telefono">üì± ${pedido.telefono}</div>
      </div>
      <div class="pedido-meta">
        <div class="pedido-estado-badge ${badgeClase}">${pedido.estado}</div>
        <div class="pedido-id-badge">${pedido.pedidoId}</div>
        <div class="pedido-fecha">${pedido.fecha}</div>
      </div>
    </div>
    
    <div class="pedido-productos-lista">
      ${productosHTML}
    </div>
    
    <div class="pedido-total-section">
      <span class="pedido-total-label">Total:</span>
      <span class="pedido-total-monto">S/ ${pedido.total.toFixed(2)}</span>
    </div>
    
    ${botonPagado}
  `;
  
  return card;
}

/* ***********************************************
   20. Marcar Como Pagado - scripts.html - V1.06-SV01
   *********************************************** */

function cambiarTabPedidos(tab) {
  // Actualizar variable global
  tabActual = tab;
  
  // Actualizar clases de botones
  const botones = document.querySelectorAll('.tab-button');
  botones.forEach(btn => {
    if (btn.dataset.tab === tab) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Re-renderizar lista con el filtro
  renderizarPedidos();
  
  console.log(`Tab cambiada a: ${tab}`);
}

function marcarComoPagado(pedidoId) {
  if (!confirm(`¬øMarcar el pedido ${pedidoId} como PAGADO?\n\nEsto actualizar√° el stock de productos vendidos.`)) {
    return;
  }
  
  LoaderGlobal.mostrar('Marcando como pagado...');
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      LoaderGlobal.ocultar();
      
      if (resultado.success) {
        mostrarExito('‚úì Pedido Pagado', 'El pedido se marc√≥ como pagado y el stock fue actualizado');
        cargarPedidos(); // Recargar lista
      } else {
        throw new Error(resultado.message || 'Error al marcar pagado');
      }
    })
    .withFailureHandler(function(error) {
      LoaderGlobal.ocultar();
      manejarError(error, 'al marcar pedido como pagado');
    })
    .marcarPagado(pedidoId);
}

/* ***********************************************
   21. Cerrar Modals al Click en Overlay - scripts.html - V1.02-SV01
   *********************************************** */

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
    // Cerrar el modal padre
    const modal = e.target.parentElement;
    if (modal && modal.classList.contains('modal')) {
      modal.style.display = 'none';
    }
  }
});

/* ***********************************************
   22. Log de Estado - scripts.html - V1.09-SV01
   *********************************************** */

console.log('Scripts cargados - Bebidas a Pedido V1.09');
</script>
